pipeline {
    // The 'agent any' is used globally, assuming the Jenkins agent has Docker installed
    agent any

    // Define environment variables if needed
    environment {
        PR_NAME = 'Review Pipeline'
        // Define other environment variables (like test-specific paths) here
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                // Ensure the code (including Dockerfile and requirements.txt) is checked out
                checkout scm
            }
        }

        stage('Run Unit Tests in Docker') {
            // Use the Dockerfile located in the repository root to build and run the container
            agent {
                dockerfile {
                    // Assumes the Dockerfile is named 'Dockerfile' and is in the root
                    // The Jenkins pipeline will automatically execute steps in the WORKDIR defined in the Dockerfile (/app)
                    
                    // You can optionally pass arguments to the 'docker build' command if needed
                    // For example: args '-f custom/Dockerfile.test'
                }
            }
            steps {
                echo "Running unit tests inside the custom Python container..."
                // Since requirements are already installed during the Docker image build (RUN pip install -r requirements.txt),
                // we skip the failing 'venv' creation and 'pip install' steps.
                
                // Now, just run your test command directly.
                // Assuming your tests are run using the standard unittest discover command:
                sh 'python -m unittest discover'
                
                // If you use pytest, the command would be 'pytest'
                // sh 'pytest'
            }
        }

        // Add deployment stage or any subsequent stages here
    }

    post {
        always {
            script {
                // The 'dockerfile' agent automatically cleans up the container after the stage completes.
                if (currentBuild.result != 'SUCCESS') {
                    echo "Review pipeline failed. Unit test failures found. PR cannot be merged yet."
                } else {
                    echo "Review pipeline passed. Unit tests succeeded."
                }
            }
        }
    }
}
